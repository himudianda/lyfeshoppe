{% extends 'dashboard/layouts/app.jinja2' %}
{% import 'dashboard/macros/items.jinja2' as items %}
{% import 'dashboard/macros/form.jinja2' as f with context %}

{% block title %}
    Businesses / List | LyfeShoppe | Social Shop with huge discounts.
{% endblock %}

{% block content %}
    {% set form_kwargs = {} %}

    <!-- BEGIN CONTENT -->
    <div class="page-content-wrapper">
        <!-- BEGIN CONTENT BODY -->
        <div class="page-content">

            <div class="modal fade bs-modal-lg" id="createEventModal" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                            <h4 class="modal-title">Create Appointment</h4>
                        </div>
                        <div class="modal-body">

                            {% set endpoint = 'backend.business_calendar' %}
                            {% set form_kwargs = {'id': business.id} %}
                            {% set legend = 'Create a new Reservation' %}
                            {% set button = _('Create') %}

                            {% call f.form_tag(endpoint, **form_kwargs) %}
                            <div class="portlet box green">
                                <div class="portlet-title">
                                    <div class="caption">
                                        <i class="fa fa-plus"></i> {{ legend }} 
                                    </div>
                                </div>
                                <div class="portlet-body form">
                                    <!-- BEGIN FORM-->
                                    <form action="#" class="form-horizontal col-md-offset-1">

                                        <div class="form-body">
                                            <h3 class="form-section">Create a Reservation</h3>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <div class="col-md-9" id="employee-name">
                                                            <h5><strong>Employee:</strong></h5>
                                                            <p></p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!--/span-->
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <div class="col-md-9">
                                                            <h5><strong>Customer:</strong></h5>
                                                            <select id="customer-select" class="bs-select" onchange="customerSelect()">
                                                                {% for customer in business.customers %}
                                                                    <option value="{{customer.id | string}}">{{customer.user.name}}</option>
                                                                {% endfor %}
                                                            </select>
                                                            </br>
                                                            {{_('New Customer?')}}
                                                            <a href="{{ url_for('backend.business_employees_new', id=business.id) }}"
                                                                class="green">
                                                                    {{ _(' First Register here.') }}
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!--/span-->
                                            </div>
                                            <!--/row-->
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <div class="col-md-9" id="booking-times">
                                                            <h5><strong>When:</strong></h5>
                                                            <p></p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!--/span-->
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <div class="col-md-9">
                                                            <h5><strong>Product:</strong></h5>
                                                            <select id="product-select" class="bs-select" onchange="productSelect()">
                                                                {% for product in business.products %}
                                                                    <option value="{{product.id | string}}">{{product.name}}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!--/span-->
                                            </div>
                                            <!--/row-->
                                            <div class="row" style="display: none;">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <div class="col-md-9">
                                                          {% call f.form_group(form.start_time, css_class='sm-margin-bottom') %}
                                                          {% endcall %}
                                                        </div>
                                                    </div>
                                                </div>
                                                <!--/span-->
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <div class="form-group">
                                                            <div class="col-md-9">
                                                              {% call f.form_group(form.end_time, css_class='sm-margin-bottom') %}
                                                              {% endcall %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!--/span-->
                                            </div>

                                            <div class="row">
                                                <div>
                                                    {{ form.employee_id() }}
                                                </div>

                                                <div>
                                                    {{ form.product_id() }}
                                                </div>

                                                <div>
                                                    {{ form.customer_id() }}
                                                </div>
                                            </div>


                                        </div>

                                        <div class="form-actions">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="row">
                                                        <div class="col-md-offset-6 col-md-12">

                                                            <div class="row">
                                                                <div class="col-md-3">
                                                                    <button id="submitButton" type="submit" class="btn green">
                                                                      {{ button }}
                                                                    </button>
                                                                </div>
                                                                <div class="col-md-3">
                                                                    <div class="visible-xs visible-sm sm-margin-top"></div>
                                                                    <a href="{{ url_for('backend.business_calendar', id=business.id) }}"
                                                                       class="btn red btn-block">
                                                                      {{ _('Cancel') }}
                                                                    </a>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6"> </div>
                                            </div>
                                        </div>
                                    </form>
                                    <!-- END FORM-->
                                </div>
                            </div>
                            {% endcall %}

                        </div>
                        <div class="modal-footer">
                        </div>
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>


            <div class="row">
                <div class="col-md-12">
                    <div class="portlet light portlet-fit  calendar">
                        <div class="portlet-title">
                            <div class="caption">
                                <i class=" icon-layers font-green"></i>&nbsp;
                                <span class="caption-subject font-green sbold uppercase">Calendar  for  Employee:  </span>
                                <select id="employee-select" class="bs-select input-large" data-style="green">
                                {% for employee in business.employees %}
                                    <option value="{{employee.id | string}}">{{employee.user.name}}</option>
                                {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="portlet-body">
                            <div class="row">
                                <div class="col-md-12 col-sm-12">
                                    <div id="calendar" class="has-toolbar"> </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <!-- END CONTENT BODY -->
    </div>
    <!-- END CONTENT -->
{% endblock %}


{% block footer_scripts %}
    <script type="text/javascript">

        var AppCalendar = function() {

            return {
                //main function to initiate the module
                init: function() {
                    this.initCalendar();
                },

                initCalendar: function() {

                    if (!jQuery().fullCalendar) {
                        return;
                    }

                    var date = new Date();
                    var d = date.getDate();
                    var m = date.getMonth();
                    var y = date.getFullYear();

                    var h = {};

                    if (App.isRTL()) {
                        if ($('#calendar').parents(".portlet").width() <= 720) {
                            $('#calendar').addClass("mobile");
                            h = {
                                right: 'title, prev, next',
                                center: '',
                                left: 'agendaDay, agendaWeek, month, today'
                            };
                        } else {
                            $('#calendar').removeClass("mobile");
                            h = {
                                right: 'title',
                                center: '',
                                left: 'agendaDay, agendaWeek, month, today, prev,next'
                            };
                        }
                    } else {
                        if ($('#calendar').parents(".portlet").width() <= 720) {
                            $('#calendar').addClass("mobile");
                            h = {
                                left: 'title, prev, next',
                                center: '',
                                right: 'today,month,agendaWeek,agendaDay'
                            };
                        } else {
                            $('#calendar').removeClass("mobile");
                            h = {
                                left: 'title',
                                center: '',
                                right: 'prev,next,today,month,agendaWeek,agendaDay'
                            };
                        }
                    }

                    var initDrag = function(el) {
                        // create an Event Object (http://arshaw.com/fullcalendar/docs/event_data/Event_Object/)
                        // it doesn't need to have a start or end
                        var eventObject = {
                            title: $.trim(el.text()) // use the element's text as the event title
                        };
                        // store the Event Object in the DOM element so we can get to it later
                        el.data('eventObject', eventObject);
                        // make the event draggable using jQuery UI
                        el.draggable({
                            zIndex: 999,
                            revert: true, // will cause the event to go back to its
                            revertDuration: 0 //  original position after the drag
                        });
                    };

                    var addEvent = function(title) {
                        title = title.length === 0 ? "Untitled Event" : title;
                        var html = $('<div class="external-event label label-default">' + title + '</div>');
                        jQuery('#event_box').append(html);
                        initDrag(html);
                    };

                    $('#external-events div.external-event').each(function() {
                        initDrag($(this));
                    });

                    $('#event_add').unbind('click').click(function() {
                        var title = $('#event_title').val();
                        addEvent(title);
                    });

                    //predefined events
                    $('#event_box').html("");
                    addEvent("My Event 1");
                    addEvent("My Event 2");
                    addEvent("My Event 3");
                    addEvent("My Event 4");
                    addEvent("My Event 5");
                    addEvent("My Event 6");

                    var events = {{ events|safe }}
                    var events_all = events.all
                    for (var i = 0; i < events_all.length; i++) {
                        // Must convert to Javascript Date object for proper display
                        // Note: Time is displayed on Calendar in Local timezone
                        events_all[i].start = new Date(events_all[i].start);
                        events_all[i].end = new Date(events_all[i].end);

                        events_all[i].backgroundColor = App.getBrandColor('green');
                        if (events_all[i].status == "cancelled"){
                            events_all[i].backgroundColor = App.getBrandColor('red');
                        } else if (events_all[i].status == "executed"){
                            events_all[i].backgroundColor = App.getBrandColor('blue');
                        }
                    }


                    $('#calendar').fullCalendar('destroy'); // destroy the calendar
                    $('#calendar').fullCalendar({ //re-initialize the calendar
                        header: h,
                        defaultView: 'agendaWeek', // change default view with available options from http://arshaw.com/fullcalendar/docs/views/Available_Views/ 
                        slotMinutes: 15,
                        editable: true,
                        selectable: true,
                        select: function(start, end, allDay) {
                            var mywhen = start.format("ddd, MMM Do, h:mm a") + ' - ' + end.format("h:mm a");

                            start.local().utc() // Convets start to UTC for formatting
                            end.local().utc() // Convets end to UTC for formatting
                            // start.utc().local() // Convets start to local for formatting
                            // end.utc().local() // Convets end to local for formatting

                            $('#employee-name p').text($('#employee-select option:selected').text());
                            $('#booking-times p').text(mywhen);

                            $('#createEventModal #customer_id').val( $('#customer-select').val() );
                            $('#createEventModal #product_id').val( $('#product-select').val() );
                            $('#createEventModal #employee_id').val( $('#employee-select').val() );

                            $('#createEventModal #start_time').val( start.format('YYYY-MM-DD HH:mm:ss') );
                            $('#createEventModal #end_time').val( end.format('YYYY-MM-DD HH:mm:ss') );

                            $('#createEventModal').modal('show');
                        },
                        events: events_all
                    });
                }
            };
        }();

        function productSelect() {
            $('#createEventModal #product_id').val($('#product-select').val());
        }

        function customerSelect() {
            $('#createEventModal #customer_id').val($('#customer-select').val());
        }
        
        jQuery(document).ready(function() {    
           AppCalendar.init();
        });
    </script>
{% endblock %}